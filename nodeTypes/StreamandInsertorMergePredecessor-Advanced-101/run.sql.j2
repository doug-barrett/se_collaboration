{# Source Stream Location and Name #}
{% set srcSchName = desiredState.sources[0].dependencies[0].node.location.name %}
{% set srcDb = desiredState.storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='database') | first %}
{% set srcSch = desiredState.storageLocations | selectattr('name', 'equalto', srcSchName) | map(attribute='schema') | first %}
{% set srcTbl = desiredState.sources[0].dependencies[0].node.name %}
{% set strName = srcTbl + '_STREAM' %}
{% set fqSrcTblName = '"' + srcDb + '"."' + srcSch + '"."' + srcTbl + '"' %}
{% set fqStrName = '"' + srcDb + '"."' + srcSch + '"."' + strName + '"' %}
{% set strFrom = desiredState.sources[0].join | replace(srcTbl, strName) %}

{# Target Table Info #}
{% set tgtDb = ref_no_link(desiredState.node.location.name, desiredState.node.name).split('.')[0] %} 
{% set tgtSch = ref_no_link(desiredState.node.location.name, desiredState.node.name).split('.')[1] %} 
{% set tgtTbl = ref_no_link(desiredState.node.location.name, desiredState.node.name) %}

{# Task Info #}
{% set taskName = desiredState.node.name + '_TASK'  %}
{%- set fqTaskName = tgtDb + '.' + tgtSch + '."' + taskName + '"' -%} 

{% set tblColid = desiredState.columns | map(attribute='id') | list %}
{% set tblCol = desiredState.columns | map(attribute='name') | list %}
{% set tblKey = desiredState.columns | selectattr('tblKey', 'defined') | map(attribute='name') | list %}
{% set tblColUpd = tblCol | reject('in', tblKeys) | list %}
{%- set tblKeyColStr = '"'+tblKey | join('", "')+'"' -%}
{% set recTS = desiredState.columns | selectattr('tblChgTS', 'defined') | map(attribute='name') | first %}

{{ stage('Create Stream') }}
CREATE OR REPLACE STREAM {{ fqStrName }}
    ON TABLE {{ fqSrcTblName }}
    APPEND_ONLY = {% if desiredState.config.appendOnly == true %} TRUE {% else %} FALSE {% endif %}
    SHOW_INITIAL_ROWS = {% if desiredState.config.initialRows == true %} TRUE {% else %} FALSE {% endif %}

    
{{ stage('Create Target Table') }}
CREATE OR REPLACE TABLE {{ tgtTbl }}
    (
    {%- for col in desiredState.columns %}
            "{{ col.name }}" {{ col.dataType }}
            {%- if col.description | length > 0 %} COMMENT '{{ col.description }}'{% endif %}
            {%- if not loop.last -%}, {% endif %}
    {%- endfor %}
    )