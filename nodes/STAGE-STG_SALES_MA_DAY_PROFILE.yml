fileVersion: 1
id: 39a4cb47-b48d-448b-9847-6d2fbeb149d3
name: STG_SALES_MA_DAY_PROFILE
operation:
  config:
    insertStrategy: UNION
    postSQL: null
    preSQL: |-
      DELETE FROM {{this}}
      WHERE DAYNAME(CURRENT_DATE) = 'Sat'
    selectDistinct: false
    testsEnabled: false
    truncateBefore: false
  database: ""
  deployEnabled: true
  description: Only recalc daily sales profile once a week
  isMultisource: false
  locationName: STAGE
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5838a6a2-8d20-4400-8a01-468cd6b6b474
          stepCounter: 39a4cb47-b48d-448b-9847-6d2fbeb149d3
        config: {}
        dataType: VARCHAR(64)
        description: ""
        name: ZONE_GEOGRAPHY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bcede211-1839-4363-b6da-6fa314efe9ac
                stepCounter: 91c3542a-c2f9-472c-8706-d613acb63e06
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 07bd46f5-d63b-4515-be9d-ce8e7430edf4
          stepCounter: 39a4cb47-b48d-448b-9847-6d2fbeb149d3
        config: {}
        dataType: VARCHAR(50)
        description: ""
        name: LEVEL3_DESC
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 76b80dd0-990c-439c-9b2a-f320fd772670
                stepCounter: 99510b9e-1d3e-4709-93b8-2042202093b0
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f6a9cc84-7e7a-41ba-9965-f222eabc6515
          stepCounter: 39a4cb47-b48d-448b-9847-6d2fbeb149d3
        config: {}
        dataType: NUMBER
        description: ""
        name: WEEK_DAY_NO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 53776bbd-937c-4506-a163-dedff0387a4a
                stepCounter: 91c3542a-c2f9-472c-8706-d613acb63e06
            transform: DAYOFWEEK("FCT_SALES_DAY"."TRANSACTION_DATE")
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e88a56d9-b361-4dd6-b884-1433e57ba0bb
          stepCounter: 39a4cb47-b48d-448b-9847-6d2fbeb149d3
        config: {}
        dataType: NUMBER(16,2)
        description: ""
        name: UNITS_DAY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1820fabd-6601-408b-87cf-7222cfc72522
                stepCounter: 91c3542a-c2f9-472c-8706-d613acb63e06
            transform: SUM("FCT_SALES_DAY"."UNITS_SALES")
      - appliedColumnTests: {}
        columnReference:
          columnCounter: afd2ee17-792e-469d-be8d-831f9aa414c1
          stepCounter: 39a4cb47-b48d-448b-9847-6d2fbeb149d3
        config: {}
        dataType: NUMBER(16,2)
        description: ""
        name: UNITS_TOTAL
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1820fabd-6601-408b-87cf-7222cfc72522
                stepCounter: 91c3542a-c2f9-472c-8706-d613acb63e06
            transform: SUM(SUM("FCT_SALES_DAY"."UNITS_SALES")) OVER (PARTITION BY FCT_SALES_DAY."ZONE_GEOGRAPHY", DIM_PRODUCT."LEVEL3_DESC")
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e34e2e4f-4ba7-4f40-90be-c7c9fc1c3874
          stepCounter: 39a4cb47-b48d-448b-9847-6d2fbeb149d3
        config: {}
        dataType: NUMBER(12,6)
        description: ""
        name: UNITS_RATIO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 1820fabd-6601-408b-87cf-7222cfc72522
                stepCounter: 91c3542a-c2f9-472c-8706-d613acb63e06
            transform: DIV0(UNITS_DAY, UNITS_TOTAL)
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          DIM_PRODUCT: 99510b9e-1d3e-4709-93b8-2042202093b0
          FCT_SALES_DAY: 91c3542a-c2f9-472c-8706-d613acb63e06
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: DATA
            nodeName: DIM_PRODUCT
          - locationName: DATA
            nodeName: FCT_SALES_DAY
        join:
          joinCondition: |-
            FROM {{ ref('DATA', 'FCT_SALES_DAY') }} "FCT_SALES_DAY"
            INNER JOIN {{ ref('DATA', 'DIM_PRODUCT') }} "DIM_PRODUCT"
            ON "FCT_SALES_DAY"."PRODKEY" = "DIM_PRODUCT"."PRODKEY"
            WHERE "FCT_SALES_DAY"."TRANSACTION_DATE" > DATEADD(MONTH, -3, CURRENT_DATE)
            AND (SELECT COUNT(1) FROM {{this}} ) = 0 
            GROUP BY 1, 2, 3
        name: STG_SALES_MA_DAY_PROFILE
        noLinkRefs:
          - locationName: STAGE
            nodeName: STG_SALES_MA_DAY_PROFILE
  name: STG_SALES_MA_DAY_PROFILE
  overrideSQL: false
  schema: ""
  sqlType: Stage
  type: sql
  version: 1
type: Node
