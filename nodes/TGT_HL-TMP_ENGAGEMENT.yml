fileVersion: 1
id: 276fd6c4-a285-4bb5-95e0-6984786504d5
name: TMP_ENGAGEMENT
operation:
  config:
    insertStrategy: UNION
    selectDistinct: false
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: TGT_HL
  materializationType: view
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 491e9dcd-dd57-41b2-a802-cc3e8ed30762
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENGAGEMENT_NUMBER
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5afd9c23-b331-4cf2-b2ca-5d2a3591043a
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENGAGEMENT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0465139f-59cd-441e-8cfe-b90d4abce8c2
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 70795feb-d2fb-47e5-853f-00b9ea59fb3f
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_LINE_OF_BUSINESS
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e9adec98-c3f7-4553-bc97-cbdfa3e210c0
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_CLIENT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 030ff025-d327-464c-8970-0d01de5b06c0
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_CLIENT_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 7483e1e1-69db-48ea-8880-a4619161fb09
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_SUBJECT_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 9454ee59-5df6-49b9-a84e-d03d33b89a68
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_SUBJECT_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ae3aa7aa-ea21-4e5d-805f-7cdede9b810d
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: DATE
        description: ""
        hashDetails: null
        name: ENG_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 2fe2988c-785e-4b09-8f00-4999684bc3fd
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_CF_JOB_TYPE2
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3a3f906b-433b-4dc2-a8ff-19f67cca4752
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: c1abd2c9-149a-42e1-896e-16c464ef0523
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_STAGE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f911d5a4-9693-4933-a867-84d76cc3b003
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: DATE
        description: ""
        hashDetails: null
        name: ENG_CLOSE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: e536983b-25de-47e8-819f-98b281adadcb
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_CURRENCY
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: f07fd75c-5697-49bd-bfd5-809b198353e3
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: NUMBER(38,0)
        description: ""
        hashDetails: null
        name: ENG_TRANSACTION_SIZE_MM_USD
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ca994621-d4e7-402b-954d-7610030a0cbc
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: NUMBER(38,6)
        description: ""
        hashDetails: null
        name: ENG_TOTAL_FEE_MUSD
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1d630040-dad4-4f78-a25d-b036ce68e988
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: DATE
        description: ""
        hashDetails: null
        name: ENG_ESTIMATED_CLOSE_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: a6f24591-5a04-4c4f-b116-3acf33c03335
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_STAFF_ID
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 916e6c2b-eaaf-4309-b372-b68eb61f6c73
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_FS_COVERAGE_OFFICER_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 69ba246f-f717-4acf-8f49-48fcbfc2030c
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: ENG_COMPANY_TIER
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5ece1b14-4c0c-49ef-a6cf-768a47232e6f
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(19)
        description: ""
        hashDetails: null
        name: ENG_FLAG
        nullable: false
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 6c377203-0600-4539-9f76-ae1f84bda6dd
          stepCounter: 276fd6c4-a285-4bb5-95e0-6984786504d5
        config: {}
        dataType: VARCHAR(16777216)
        description: ""
        hashDetails: null
        name: DND_STATUS
        nullable: true
        sourceColumnReferences:
          - columnReferences: []
            transform: ""
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases: {}
        customSQL:
          customSQL: |-
            {{ stage('Override Create SQL') }}
            	CREATE OR REPLACE VIEW {{ ref('TGT_HL', 'TMP_ENGAGEMENT')}} AS (
                SELECT ENGAGEMENT_NUMBER AS ENGAGEMENT_NUMBER
                    ,ENGAGEMENT_ID AS ENGAGEMENT_ID
                    ,ENG_NAME AS ENG_NAME
                    ,ENG_LINE_OF_BUSINESS AS ENG_LINE_OF_BUSINESS
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Client_ID
                        END AS ENG_Client_ID
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Client_Name
                        END AS ENG_Client_Name
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Subject_ID
                        END AS ENG_Subject_ID
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Subject_Name
                        END AS ENG_Subject_Name
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Date
                        END AS ENG_Date
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE CF_Job_Type2
                        END AS ENG_CF_Job_Type2
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_STATUS
                        END AS ENG_STATUS
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_STAGE
                        END AS ENG_STAGE
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Close_Date
                        END AS ENG_Close_Date
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Currency
                        END AS ENG_Currency
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Transaction_Size_MM_USD
                        END AS ENG_Transaction_Size_MM_USD
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE Total_Fee_MUSD
                        END AS ENG_Total_Fee_MUSD
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Estimated_Close_Date
                        END AS ENG_Estimated_Close_Date
                    ,ENG_Staff_ID AS ENG_Staff_ID
                    ,Coverage_Officer_Name AS ENG_FS_Coverage_Officer_Name
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE Company_TIER
                        END AS ENG_Company_TIER
                    ,Flag AS ENG_Flag
                    ,DND_STATUS
                FROM (
                    SELECT ENGAGEMENT_NUMBER
                        ,ENGAGEMENT_ID
                        ,ENG_NAME
                        ,ENG_LINE_OF_BUSINESS
                        ,ENG_Client_ID
                        ,ENG_Client_Name
                        ,ENG_Subject_ID
                        ,ENG_Subject_Name
                        ,ENG_Date
                        ,CF_Job_Type2
                        ,ENG_STATUS
                        ,ENG_STAGE
                        ,ENG_Close_Date
                        ,ENG_Currency
                        ,ENG_Transaction_Size_MM_USD
                        ,Total_Fee_MUSD
                        ,ENG_Estimated_Close_Date
                        ,ENG_Staff_ID
                        ,Coverage_Officer_Name
                        ,Company_TIER
                        ,'Staffed On Deal' AS Flag
                        ,DND_STATUS
                    FROM {{ref('TGT_HL','TMP_ENGAGEMENT_TEMP')}} AS a
                    WHERE Coverage_Officer_ID = ENG_Staff_ID

                    UNION ALL

                    SELECT DISTINCT a.ENGAGEMENT_NUMBER
                        ,a.ENGAGEMENT_ID
                        ,a.ENG_NAME
                        ,a.ENG_LINE_OF_BUSINESS
                        ,a.ENG_Client_ID
                        ,A.ENG_Client_Name
                        ,a.ENG_Subject_ID
                        ,a.ENG_Subject_Name
                        ,a.ENG_Date
                        ,a.CF_Job_Type2
                        ,a.ENG_STATUS
                        ,a.ENG_STAGE
                        ,a.ENG_Close_Date
                        ,a.ENG_Currency
                        ,a.ENG_Transaction_Size_MM_USD
                        ,a.Total_Fee_MUSD
                        ,a.ENG_Estimated_Close_Date
                        ,a.ENG_Staff_ID
                        ,a.Coverage_Officer_Name
                        ,a.Company_TIER
                        ,'Not Staffed On Deal' AS Flag
                        ,A.DND_STATUS
                    FROM {{ref('TGT_HL','TMP_ENGAGEMENT_TEMP')}} a
                    LEFT JOIN {{ref('TGT_HL','TMP_ENGAGEMENT_TEMP')}} b ON a.ENGAGEMENT_NUMBER = b.ENGAGEMENT_NUMBER
                        AND a.Coverage_Officer_ID = b.ENG_Staff_ID
                    WHERE b.ENGAGEMENT_NUMBER IS NULL
                        AND b.ENG_Staff_ID IS NULL

                    UNION ALL

                    SELECT DISTINCT a.ENGAGEMENT_NUMBER_C AS ENGAGEMENT_NUMBER
                        ,a.FULL_ENGAGEMENT_ID_C AS ENGAGEMENT_ID
                        ,a.NAME ENG_NAME
                        ,a.LINE_OF_BUSINESS_C AS ENG_LINE_OF_BUSINESS
                        ,a.CLIENT_C AS ENG_Client_ID
                        ,CLIENT.NAME AS ENG_Client_Name
                        ,a.SUBJECT_C AS ENG_Subject_ID
                        ,a.ORIGINAL_SUBJECT_NAME_C AS ENG_Subject_Name
                        ,a.DATE_ENGAGED_C AS ENG_Date
                        ,a.JOB_TYPE_C AS CF_Job_Type2
                        ,a.STATUS_C AS ENG_STATUS
                        ,a.STAGE_C AS ENG_STAGE
                        ,a.CLOSE_DATE_C AS ENG_Close_Date
                        ,a.CURRENCY_ISO_CODE AS ENG_Currency
                        ,a.EST_TRANSACTION_SIZE_MM_C AS ENG_Transaction_Size_MM_USD
                        ,a.TOTAL_FEE_C / 1000000 AS Total_Fee_MUSD
                        ,a.ESTIMATED_CLOSE_DATE_C AS ENG_Estimated_Close_Date
                        ,c.HL_ID AS Coverage_Officer_ID
                        ,c.FULL_NAME AS Coverage_Officer_Name
                        ,'Not Covered' AS Company_TIER
                        ,'Staffed On Deal' AS Flag
                        ,DND_STATUS_C
                    FROM {{ref('TGT_HL','VW_ENGAGEMENT_C')}} a 
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS CLIENT ON a.CLIENT_C = CLIENT.ID
                    INNER JOIN {{ref('TGT_HL','VW_ENGAGEMENT_INTERNAL_TEAM_C')}} b 
                        ON a.ENGAGEMENT_NUMBER_C = b.ENGAGEMENT_NUMBER_C
                    INNER JOIN {{ref('TGT_HL','TMP_HLEMPLOYEE')}} c ON b.CONTACT_C = c.HL_ID
                    WHERE  NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = a.CLIENT_C
                            AND b.CONTACT_C = Coverage_Officer_ID
                            )
                        AND NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = a.SUBJECT_C
                            AND b.CONTACT_C = Coverage_Officer_ID
                        )
                        AND UPPER(a.LINE_OF_BUSINESS_C) IN (
                            'CF'
                            ,'FR'
                            )
                        AND (
                            (
                                UPPER(a.STATUS_C) = UPPER('Closed')
                                AND a.CLOSE_DATE_C >= CASE 
                                    WHEN MONTH(GETDATE()) >= 4
                                        THEN CONCAT (
                                                '04/01/'
                                                ,LTRIM(YEAR(GETDATE()))
                                                )
                                    ELSE CONCAT (
                                            '04/01/'
                                            ,LTRIM(YEAR(GETDATE()) - 1)
                                            )
                                    END
                                AND a.CLOSE_DATE_C <= CASE 
                                    WHEN MONTH(GETDATE()) >= 4
                                        THEN CONCAT (
                                                '03/31/'
                                                ,LTRIM(YEAR(GETDATE()) + 1)
                                                )
                                    ELSE CONCAT (
                                            '03/31/'
                                            ,LTRIM(YEAR(GETDATE()))
                                            )
                                    END
                                )
                            OR UPPER(a.STATUS_C) IN (
                                UPPER('Active')
                                ,UPPER('Hold')
                                )
                            )
                        AND UPPER(b.ROLE_C) IN (
                             UPPER('Initiator')
                            ,UPPER('Seller')
                            ,UPPER('Principal')
                            ,UPPER('Manager')
                            ,UPPER('Associate')
                            ,UPPER('Analyst')
                            )
                    ) Eng
            	)
        dependencies:
          - locationName: TGT_HL
            nodeName: TMP_COVERAGE_ENGAGEMENT
          - locationName: TGT_HL
            nodeName: TMP_ENGAGEMENT_TEMP
          - locationName: TGT_HL
            nodeName: TMP_HLEMPLOYEE
          - locationName: TGT_HL
            nodeName: VW_ACCOUNT
          - locationName: TGT_HL
            nodeName: VW_ENGAGEMENT_C
          - locationName: TGT_HL
            nodeName: VW_ENGAGEMENT_INTERNAL_TEAM_C
        join:
          joinCondition: |2-
                SELECT ENGAGEMENT_NUMBER AS ENGAGEMENT_NUMBER
                    ,ENGAGEMENT_ID AS ENGAGEMENT_ID
                    ,ENG_NAME AS ENG_NAME
                    ,ENG_LINE_OF_BUSINESS AS ENG_LINE_OF_BUSINESS
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Client_ID
                        END AS ENG_Client_ID
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Client_Name
                        END AS ENG_Client_Name
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Subject_ID
                        END AS ENG_Subject_ID
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Subject_Name
                        END AS ENG_Subject_Name
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Date
                        END AS ENG_Date
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE CF_Job_Type2
                        END AS ENG_CF_Job_Type2
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_STATUS
                        END AS ENG_STATUS
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_STAGE
                        END AS ENG_STAGE
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Close_Date
                        END AS ENG_Close_Date
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE ENG_Currency
                        END AS ENG_Currency
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Transaction_Size_MM_USD
                        END AS ENG_Transaction_Size_MM_USD
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE Total_Fee_MUSD
                        END AS ENG_Total_Fee_MUSD
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN NULL
                        ELSE ENG_Estimated_Close_Date
                        END AS ENG_Estimated_Close_Date
                    ,ENG_Staff_ID AS ENG_Staff_ID
                    ,Coverage_Officer_Name AS ENG_FS_Coverage_Officer_Name
                    ,CASE 
                        WHEN UPPER(DND_STATUS) = 'APPROVED'
                            THEN ''
                        ELSE Company_TIER
                        END AS ENG_Company_TIER
                    ,Flag AS ENG_Flag
                    ,DND_STATUS
                FROM (
                    SELECT ENGAGEMENT_NUMBER
                        ,ENGAGEMENT_ID
                        ,ENG_NAME
                        ,ENG_LINE_OF_BUSINESS
                        ,ENG_Client_ID
                        ,ENG_Client_Name
                        ,ENG_Subject_ID
                        ,ENG_Subject_Name
                        ,ENG_Date
                        ,CF_Job_Type2
                        ,ENG_STATUS
                        ,ENG_STAGE
                        ,ENG_Close_Date
                        ,ENG_Currency
                        ,ENG_Transaction_Size_MM_USD
                        ,Total_Fee_MUSD
                        ,ENG_Estimated_Close_Date
                        ,ENG_Staff_ID
                        ,Coverage_Officer_Name
                        ,Company_TIER
                        ,'Staffed On Deal' AS Flag
                        ,DND_STATUS
                    FROM {{ref('TGT_HL','TMP_ENGAGEMENT_TEMP')}} AS a
                    WHERE Coverage_Officer_ID = ENG_Staff_ID

                    UNION ALL

                    SELECT DISTINCT a.ENGAGEMENT_NUMBER
                        ,a.ENGAGEMENT_ID
                        ,a.ENG_NAME
                        ,a.ENG_LINE_OF_BUSINESS
                        ,a.ENG_Client_ID
                        ,A.ENG_Client_Name
                        ,a.ENG_Subject_ID
                        ,a.ENG_Subject_Name
                        ,a.ENG_Date
                        ,a.CF_Job_Type2
                        ,a.ENG_STATUS
                        ,a.ENG_STAGE
                        ,a.ENG_Close_Date
                        ,a.ENG_Currency
                        ,a.ENG_Transaction_Size_MM_USD
                        ,a.Total_Fee_MUSD
                        ,a.ENG_Estimated_Close_Date
                        ,a.ENG_Staff_ID
                        ,a.Coverage_Officer_Name
                        ,a.Company_TIER
                        ,'Not Staffed On Deal' AS Flag
                        ,A.DND_STATUS
                    FROM {{ref('TGT_HL','TMP_ENGAGEMENT_TEMP')}} a
                    LEFT JOIN {{ref('TGT_HL','TMP_ENGAGEMENT_TEMP')}} b ON a.ENGAGEMENT_NUMBER = b.ENGAGEMENT_NUMBER
                        AND a.Coverage_Officer_ID = b.ENG_Staff_ID
                    WHERE b.ENGAGEMENT_NUMBER IS NULL
                        AND b.ENG_Staff_ID IS NULL

                    UNION ALL

                    SELECT DISTINCT a.ENGAGEMENT_NUMBER_C AS ENGAGEMENT_NUMBER
                        ,a.FULL_ENGAGEMENT_ID_C AS ENGAGEMENT_ID
                        ,a.NAME ENG_NAME
                        ,a.LINE_OF_BUSINESS_C AS ENG_LINE_OF_BUSINESS
                        ,a.CLIENT_C AS ENG_Client_ID
                        ,CLIENT.NAME AS ENG_Client_Name
                        ,a.SUBJECT_C AS ENG_Subject_ID
                        ,a.ORIGINAL_SUBJECT_NAME_C AS ENG_Subject_Name
                        ,a.DATE_ENGAGED_C AS ENG_Date
                        ,a.JOB_TYPE_C AS CF_Job_Type2
                        ,a.STATUS_C AS ENG_STATUS
                        ,a.STAGE_C AS ENG_STAGE
                        ,a.CLOSE_DATE_C AS ENG_Close_Date
                        ,a.CURRENCY_ISO_CODE AS ENG_Currency
                        ,a.EST_TRANSACTION_SIZE_MM_C AS ENG_Transaction_Size_MM_USD
                        ,a.TOTAL_FEE_C / 1000000 AS Total_Fee_MUSD
                        ,a.ESTIMATED_CLOSE_DATE_C AS ENG_Estimated_Close_Date
                        ,c.HL_ID AS Coverage_Officer_ID
                        ,c.FULL_NAME AS Coverage_Officer_Name
                        ,'Not Covered' AS Company_TIER
                        ,'Staffed On Deal' AS Flag
                        ,DND_STATUS_C
                    FROM {{ref('TGT_HL','VW_ENGAGEMENT_C')}} a 
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS CLIENT ON a.CLIENT_C = CLIENT.ID
                    INNER JOIN {{ref('TGT_HL','VW_ENGAGEMENT_INTERNAL_TEAM_C')}} b 
                        ON a.ENGAGEMENT_NUMBER_C = b.ENGAGEMENT_NUMBER_C
                    INNER JOIN {{ref('TGT_HL','TMP_HLEMPLOYEE')}} c ON b.CONTACT_C = c.HL_ID
                    WHERE  NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = a.CLIENT_C
                            AND b.CONTACT_C = Coverage_Officer_ID
                            )
                        AND NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = a.SUBJECT_C
                            AND b.CONTACT_C = Coverage_Officer_ID
                        )
                        AND UPPER(a.LINE_OF_BUSINESS_C) IN (
                            'CF'
                            ,'FR'
                            )
                        AND (
                            (
                                UPPER(a.STATUS_C) = UPPER('Closed')
                                AND a.CLOSE_DATE_C >= CASE 
                                    WHEN MONTH(GETDATE()) >= 4
                                        THEN CONCAT (
                                                '04/01/'
                                                ,LTRIM(YEAR(GETDATE()))
                                                )
                                    ELSE CONCAT (
                                            '04/01/'
                                            ,LTRIM(YEAR(GETDATE()) - 1)
                                            )
                                    END
                                AND a.CLOSE_DATE_C <= CASE 
                                    WHEN MONTH(GETDATE()) >= 4
                                        THEN CONCAT (
                                                '03/31/'
                                                ,LTRIM(YEAR(GETDATE()) + 1)
                                                )
                                    ELSE CONCAT (
                                            '03/31/'
                                            ,LTRIM(YEAR(GETDATE()))
                                            )
                                    END
                                )
                            OR UPPER(a.STATUS_C) IN (
                                UPPER('Active')
                                ,UPPER('Hold')
                                )
                            )
                        AND UPPER(b.ROLE_C) IN (
                             UPPER('Initiator')
                            ,UPPER('Seller')
                            ,UPPER('Principal')
                            ,UPPER('Manager')
                            ,UPPER('Associate')
                            ,UPPER('Analyst')
                            )
                    ) Eng
        name: TMP_ENGAGEMENT
        noLinkRefs: []
  name: TMP_ENGAGEMENT
  overrideSQL: true
  schema: ""
  sqlType: "154"
  type: sql
  version: 1
type: Node
