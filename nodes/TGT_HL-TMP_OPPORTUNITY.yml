steps:
  TMP_OPPORTUNITY-87c08224-2455-4b17-b493-83876e56491e:
    operation:
      config:
        insertStrategy: UNION
        postSQL: null
        preSQL: null
        selectDistinct: false
        testsEnabled: false
        truncateBefore: false
      database: ""
      deployEnabled: true
      description: ""
      isMultisource: false
      locationName: TGT_HL
      materializationType: view
      metadata:
        appliedNodeTests: []
        columns:
          - appliedColumnTests:
              hasNull: true
              isDistinct: true
            columnReference:
              columnCounter: 491049ca-2ca0-4ee8-bb0e-25393addf462
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPPORTUNITY_NUMBER
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: true
              isDistinct: false
            columnReference:
              columnCounter: 3748a216-362f-41e6-a576-ca1798c8f5e0
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 9136a38e-55c4-4ea1-b74c-1cf58e4b09f3
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_NAME
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: "\"VW_OPPORTUNITY_C\".\"NAME\""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 729814ef-ab7b-4994-a677-8b70e56bd75c
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_LINE_OF_BUSINESS
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: c3b064e8-b82b-4ead-8a18-9797a15d9c02
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_CLIENT_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: ca1b16c0-16d2-4753-a109-6dab3c95a073
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_CLIENT_NAME
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 9ffc3b47-b8e8-47c5-94bd-5a4355949b33
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_SUBJECT_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 2f648194-308c-48fa-a947-1736b1f282e3
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_SUBJECT_NAME
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 971a6eb5-c6d1-455c-b57b-2d9840b4a930
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_CF_JOB_TYPE2
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 8a7c9ae2-f59f-462c-8ae9-e816de9ef36e
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_JOB_TYPE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 7b1e2084-e0b6-42d8-87b9-223053850bf4
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_STATUS
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 4e820cd4-cc5a-49e3-921c-6c4928724967
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_ENGAGEMENT_NUMBER
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: f511a3f9-9f8b-46ca-bd09-be00bf301e91
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: STRING
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_STAGE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 893e8e82-5625-4d8e-8bb2-5687d4ce385f
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: TIMESTAMP_TZ(9)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_CREATE_DATE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 836eb556-3757-4f4f-99b9-e3b25003a7f4
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: BOOLEAN
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_NBC_APPROVED
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: eb11d06a-6e54-4de7-bd75-b3665869764f
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: DATE
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_NBC_DATE_SUBMITTED
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: adfea86f-64aa-4554-8920-65b75d8f554a
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: DATE
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_NBC_DATE_APPROVED
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: cb3e803d-4481-471b-8f79-9d281353faf9
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: DATE
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_PITCH_DATE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 2ec427e1-0eed-4b6f-a6bd-e54d944148d4
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_CURRENCY
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 2fa0b536-e51f-42b7-88ef-0da75f6f712f
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: FLOAT
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_MAX_FEE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: ec15ace5-5e5d-44a9-a1eb-22ff7a1ed182
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: FLOAT
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_MIN_FEE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 31700567-a973-4adf-afee-845ff199146f
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: FLOAT
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_TOTAL_FEE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 270e91e9-b3c2-40a2-81a1-a05643d2688e
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: DATE
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_ESTIMATED_CLOSE_DATE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: b0c34e94-2aab-434c-b009-bdec38cf8aef
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_STAFF_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: b9acaed7-2d90-4b1a-a2fd-a5eed60a3696
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_STAFF_NAME
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 34ef3513-a7ff-4187-a9f9-9223c516268e
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_STAFF_ROLE
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 1ae5019f-e2e6-4f17-a7aa-eab148e0cecc
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_COVERAGE_OFFICER_ID
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: e0430f70-b04f-4985-a760-fb1584fef37a
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_COVERAGE_OFFICER_NAME
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 5ce5c3ef-a0a3-48f7-8166-a3b299e4acec
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_COMPANY_TIER
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 48b21e13-6e61-4d12-8923-fe3843b7f783
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(19)
            description: ""
            hashColumns: []
            hashDetails: null
            name: OPP_FLAG
            nullable: false
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: 351981ef-78d4-4098-9a9e-223ac88fde42
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: LEGAL_ENTITY
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
          - appliedColumnTests:
              hasNull: false
              isDistinct: false
            columnReference:
              columnCounter: ee07bd5b-fb4a-40c6-ae93-9630522e3c58
              stepCounter: 87c08224-2455-4b17-b493-83876e56491e
            dataType: VARCHAR(16777216)
            description: ""
            hashColumns: []
            hashDetails: null
            name: DND_STATUS
            nullable: true
            sourceColumnReferences:
              - columnReferences: []
                transform: ""
        cteString: ""
        enabledColumnTestIDs:
          - hasNull
          - isDistinct
        sourceMapping:
          - aliases: {}
            customSQL:
              customSQL: |-
                {{ stage('Override Create SQL') }}
                	CREATE OR REPLACE VIEW {{ ref('TGT_HL', 'TMP_OPPORTUNITY')}} AS (
                    SELECT DISTINCT Opportunity_NUMBER AS Opportunity_NUMBER
                        ,OPP_ID AS OPP_ID
                        ,NAME AS OPP_NAME
                        ,OPP_LINE_OF_BUSINESS AS OPP_LINE_OF_BUSINESS
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Client_ID
                            END AS OPP_Client_ID
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Client_Name
                            END AS OPP_Client_Name
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Subject_ID
                            END AS OPP_Subject_ID
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Subject_Name
                            END AS OPP_Subject_Name
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE CF_Job_Type2
                            END AS OPP_CF_Job_Type2
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_JOB_TYPE
                            END AS OPP_JOB_TYPE
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_STATUS
                            END AS OPP_STATUS
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE ENGAGEMENT_NUMBER
                            END AS OPP_ENGAGEMENT_NUMBER
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_STAGE
                            END AS OPP_STAGE
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Create_Date
                            END AS OPP_Create_Date
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN 0
                            ELSE OPP_NBC_Approved
                            END AS OPP_NBC_Approved
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_NBC_Date_Submitted
                            END AS OPP_NBC_Date_Submitted
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_NBC_Date_Approved
                            END AS OPP_NBC_Date_Approved
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Pitch_Date
                            END AS OPP_Pitch_Date
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Currency
                            END AS OPP_Currency
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Max_Fee
                            END AS OPP_Max_Fee
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Min_Fee
                            END AS OPP_Min_Fee
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Total_Fee
                            END AS OPP_Total_Fee
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Estimated_Close_Date
                            END AS OPP_Estimated_Close_Date
                        ,OPP_Staff_ID AS OPP_Staff_ID
                        ,OPP_Staff_Name AS OPP_Staff_Name
                        ,OPP_Staff_Role AS OPP_Staff_Role
                        ,Coverage_Officer_ID AS OPP_Coverage_Officer_ID
                        ,Coverage_Officer_Name AS OPP_Coverage_Officer_Name
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE Company_TIER
                            END AS OPP_Company_TIER
                        ,Flag AS OPP_Flag
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE LEGAL_ENTITY
                            END AS LEGAL_ENTITY
                        ,DND_STATUS AS DND_STATUS
                    FROM (
                    SELECT DISTINCT SFOpportunity.OPPORTUNITY_NUMBER_C AS Opportunity_NUMBER
                        ,SFOpportunity.FULL_OPPORTUNITY_ID_C AS OPP_ID
                        ,SFOpportunity.NAME AS NAME
                        ,SFOpportunity.LINE_OF_BUSINESS_C AS OPP_LINE_OF_BUSINESS
                        ,SFOpportunity.CLIENT_C AS OPP_Client_ID
                        ,CLIENT.NAME AS OPP_Client_Name 
                        ,SFOpportunity.SUBJECT_C AS OPP_Subject_ID
                        ,SFOpportunity.ORIGINAL_SUBJECT_NAME_C AS OPP_Subject_Name
                        ,SFOpportunity.JOB_TYPE_C AS CF_Job_Type2
                        ,CASE 
                            WHEN UPPER(SFOpportunity.JOB_TYPE_C) LIKE UPPER('%Advisory%')
                                THEN 'Advisory'
                            ELSE SFOpportunity.JOB_TYPE_C
                            END AS OPP_JOB_TYPE
                        ,SFOpportunity.STATUS_C AS OPP_STATUS
                        ,SFEngagement.ENGAGEMENT_NUMBER_C AS ENGAGEMENT_NUMBER
                        ,SFOpportunity.STAGE_C AS OPP_STAGE
                        ,SFOpportunity.CREATED_DATE AS OPP_Create_Date
                        ,SFOpportunityApproval.APPROVED_C AS OPP_NBC_Approved
                        ,SFOpportunityApproval.DATE_SUBMITTED_C AS OPP_NBC_Date_Submitted
                        ,SFOpportunityApproval.DATE_GRADED_C AS OPP_NBC_Date_Approved
                        ,SFOpportunity.PITCH_DATE_C AS OPP_Pitch_Date
                        ,SFOpportunity.CURRENCY_ISO_CODE AS OPP_Currency
                        ,(SFOpportunity.MAX_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Max_Fee
                        ,(SFOpportunity.MIN_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Min_Fee
                        ,(SFOpportunity.TOTAL_ESTIMATED_FEE_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Total_Fee
                        ,SFOpportunity.ESTIMATED_CLOSE_DATE_C AS OPP_Estimated_Close_Date
                        ,SFOpportunityInternalTeam.CONTACT_C AS OPP_Staff_ID
                        ,SFOpportunityInternalTeam.CONTACT_NAME_C AS OPP_Staff_Name
                        ,SFOpportunityInternalTeam.ROLE_C AS OPP_Staff_Role
                        ,Coverage_Table.Coverage_Officer_ID
                        ,Coverage_Table.Coverage_Officer_Name
                        ,Coverage_Table.Company_TIER
                        ,CASE 
                            WHEN Coverage_Table.Coverage_Officer_ID IN (
                                    SELECT CONTACT_C
                                    FROM OPPORTUNITY_INTERNAL_TEAM_C AS a
                                    WHERE SFOpportunity.OPPORTUNITY_NUMBER_C = a.OPPORTUNITY_NUMBER_C
                                        AND UPPER(a.ROLE_C) <> UPPER('Marketing Team')
                                    )
                                THEN 'Staffed On Deal'
                            ELSE 'Not Staffed On Deal'
                            END AS Flag
                        ,LEGAL_ENTITY.NAME AS LEGAL_ENTITY
                        ,SFOpportunity.DND_STATUS_C DND_STATUS
                    FROM {{ref('TGT_HL','VW_OPPORTUNITY_C')}} AS SFOpportunity 
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS CLIENT ON SFOpportunity.CLIENT_C = CLIENT.ID 
                    LEFT JOIN {{ref('TGT_HL','VW_OPPORTUNITY_APPROVAL_C')}} AS SFOpportunityApproval 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityApproval.OPPORTUNITY_NUMBER_C
                    LEFT JOIN {{ref('TGT_HL','VW_ENGAGEMENT_C')}} AS SFEngagement  
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFEngagement.OPPORTUNITY_NUMBER_C
                    INNER JOIN {{ref('TGT_HL','VW_OPPORTUNITY_INTERNAL_TEAM_C')}} AS SFOpportunityInternalTeam  
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityInternalTeam.OPPORTUNITY_NUMBER_C
                        AND UPPER(SFOpportunityInternalTeam.ROLE_C) NOT IN (UPPER('Marketing Team'))
                    INNER JOIN {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table ON (
                            SFOpportunity.CLIENT_C = Coverage_Table.Company_ID
                            OR SFOpportunity.SUBJECT_C = Coverage_Table.Company_ID
                            )
                    LEFT JOIN {{ref('TGT_HL','VW_LEGAL_ENTITY_C')}} LEGAL_ENTITY ON SFOPPORTUNITY.LEGAL_ENTITY_C = LEGAL_ENTITY.ID 
                    INNER JOIN {{ref('TGT_HL','VW_EXCHANGE_RATE_C')}} AS EXCHANGE_RATE  
                        ON SFOpportunity.CURRENCY_ISO_CODE = EXCHANGE_RATE.CURRENCY_ISO_CODE
                    WHERE UPPER(SFOpportunity.LINE_OF_BUSINESS_C) IN (
                            'CF'
                            ,'FR'
                            )
                        AND SFOpportunity.STAGE_C IS NOT NULL
                        AND DATEDIFF(YEAR, SFOpportunity.CREATED_DATE, GETDATE()) <= 5 
                        AND NOT (
                            UPPER(SFOpportunity.STATUS_C) IN (
                                UPPER('Dead')
                                ,UPPER('Closed')
                                )
                            AND SFOpportunity.CREATED_DATE < CAST(CONCAT (
                                    '04/01/'
                                    ,TO_VARCHAR(YEAR(GETDATE()))
                                    ) AS DATE)
                            )

                    UNION

                    SELECT DISTINCT SFOpportunity.OPPORTUNITY_NUMBER_C AS Opportunity_NUMBER
                        ,SFOpportunity.FULL_OPPORTUNITY_ID_C AS OPP_ID
                        ,SFOpportunity.NAME
                        ,SFOpportunity.LINE_OF_BUSINESS_C AS OPP_LINE_OF_BUSINESS
                        ,SFOpportunity.CLIENT_C AS OPP_Client_ID
                        ,CLIENT.NAME AS OPP_Client_Name 
                        ,SFOpportunity.SUBJECT_C AS OPP_Subject_ID
                        ,SFOpportunity.ORIGINAL_SUBJECT_NAME_C AS OPP_Subject_Name
                        ,SFOpportunity.JOB_TYPE_C AS CF_Job_Type2
                        ,CASE 
                            WHEN UPPER(SFOpportunity.JOB_TYPE_C) LIKE UPPER('%Advisory%')
                                THEN 'Advisory'
                            ELSE SFOpportunity.JOB_TYPE_C
                            END AS OPP_JOB_TYPE
                        ,SFOpportunity.STATUS_C AS OPP_STATUS
                        ,SFEngagement.ENGAGEMENT_NUMBER_C AS ENGAGEMENT_NUMBER
                        ,SFOpportunity.STAGE_C AS OPP_STAGE
                        ,SFOpportunity.CREATED_DATE AS OPP_Create_Date
                        ,SFOpportunityApproval.APPROVED_C AS OPP_NBC_Approved
                        ,SFOpportunityApproval.DATE_SUBMITTED_C AS OPP_NBC_Date_Submitted
                        ,SFOpportunityApproval.DATE_GRADED_C AS OPP_NBC_Date_Approved
                        ,SFOpportunity.PITCH_DATE_C AS OPP_Pitch_Date
                        ,SFOpportunity.CURRENCY_ISO_CODE AS OPP_Currency
                        ,(SFOpportunity.MAX_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Max_Fee
                        ,(SFOpportunity.MIN_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Min_Fee
                        ,(SFOpportunity.TOTAL_ESTIMATED_FEE_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Total_Fee
                        ,SFOpportunity.ESTIMATED_CLOSE_DATE_C AS OPP_Estimated_Close_Date
                        ,SFOpportunityInternalTeam.CONTACT_C AS OPP_Staff_ID
                        ,SFOpportunityInternalTeam.CONTACT_NAME_C AS OPP_Staff_Name
                        ,SFOpportunityInternalTeam.ROLE_C AS OPP_Staff_Role
                        ,HLEmployee.HL_ID AS Coverage_Officer_ID
                        ,HLEmployee.FULL_NAME AS Coverage_Officer_Name
                        ,'Not Covered' AS Company_TIER
                        ,'Staffed On Deal' AS Flag
                        ,LEGAL_ENTITY.NAME AS LEGAL_ENTITY
                        ,SFOpportunity.DND_STATUS_C
                    FROM {{ref('TGT_HL','VW_OPPORTUNITY_C')}} AS SFOpportunity 
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS CLIENT ON SFOpportunity.CLIENT_C = CLIENT.ID
                    LEFT JOIN {{ref('TGT_HL','VW_OPPORTUNITY_APPROVAL_C')}} AS SFOpportunityApproval 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityApproval.OPPORTUNITY_NUMBER_C
                    LEFT JOIN {{ref('TGT_HL','VW_ENGAGEMENT_C')}} AS SFEngagement 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFEngagement.OPPORTUNITY_NUMBER_C
                    INNER JOIN {{ref('TGT_HL','VW_OPPORTUNITY_INTERNAL_TEAM_C')}} AS SFOpportunityInternalTeam 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityInternalTeam.OPPORTUNITY_NUMBER_C
                        AND SFOpportunityInternalTeam.ROLE_C NOT IN ('Marketing Team')
                    INNER JOIN {{ref('TGT_HL','TMP_HLEMPLOYEE')}} HLEmployee ON SFOpportunityInternalTeam.CONTACT_C = HLEmployee.HL_ID
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS SFAccount 
                        ON SFOpportunity.CLIENT_C = SFAccount.ID
                    INNER JOIN (SELECT '' ID, '' DEVELOPER_NAME)   AS SFRecordType  
                        ON SFAccount.RECORD_TYPE_ID = SFRecordType.ID
                    INNER JOIN (SELECT '' ID, '' DEVELOPER_NAME)  AS SFRecordTypeOpp 
                        ON SFOpportunity.RECORD_TYPE_ID = SFRecordTypeOpp.ID
                    LEFT JOIN {{ref('TGT_HL','VW_LEGAL_ENTITY_C')}} LEGAL_ENTITY ON SFOPPORTUNITY.LEGAL_ENTITY_C = LEGAL_ENTITY.ID
                    INNER JOIN {{ref('TGT_HL','VW_EXCHANGE_RATE_C')}} AS EXCHANGE_RATE  
                        ON SFOpportunity.CURRENCY_ISO_CODE = EXCHANGE_RATE.CURRENCY_ISO_CODE
                    WHERE UPPER(SFOpportunity.LINE_OF_BUSINESS_C) IN (
                            'CF'
                            ,'FR'
                            )
                        AND UPPER(SFRecordTypeOpp.DEVELOPER_NAME) IN (
                            'CF'
                            ,'FR'
                            ,'FAS'
                            )
                        AND SFOpportunity.STAGE_C IS NOT NULL
                        AND DATEDIFF(YEAR, SFOpportunity.CREATED_DATE, GETDATE()) <= 5 
                        AND NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = SFOpportunity.CLIENT_C
                            AND SFOpportunityInternalTeam.CONTACT_C = Coverage_Officer_ID
                            )
                        AND NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = SFOpportunity.SUBJECT_C
                            AND SFOpportunityInternalTeam.CONTACT_C = Coverage_Officer_ID
                            )
                        AND NOT (
                            UPPER(SFOpportunity.STATUS_C) IN (
                                UPPER('Dead')
                                ,UPPER('Closed')
                                )
                            AND SFOpportunity.CREATED_DATE < CAST(CONCAT (
                                    '04/01/'
                                    ,TO_VARCHAR(YEAR(GETDATE()))
                                    ) AS DATE)
                            )
                    ) OPP
                	)
            dependencies:
              - locationName: TGT_HL
                nodeName: TMP_COVERAGE_ENGAGEMENT
              - locationName: TGT_HL
                nodeName: TMP_HLEMPLOYEE
              - locationName: TGT_HL
                nodeName: VW_ACCOUNT
              - locationName: TGT_HL
                nodeName: VW_ENGAGEMENT_C
              - locationName: TGT_HL
                nodeName: VW_EXCHANGE_RATE_C
              - locationName: TGT_HL
                nodeName: VW_LEGAL_ENTITY_C
              - locationName: TGT_HL
                nodeName: VW_OPPORTUNITY_APPROVAL_C
              - locationName: TGT_HL
                nodeName: VW_OPPORTUNITY_C
              - locationName: TGT_HL
                nodeName: VW_OPPORTUNITY_INTERNAL_TEAM_C
            join:
              joinCondition: |2-
                    SELECT DISTINCT Opportunity_NUMBER AS Opportunity_NUMBER
                        ,OPP_ID AS OPP_ID
                        ,NAME AS OPP_NAME
                        ,OPP_LINE_OF_BUSINESS AS OPP_LINE_OF_BUSINESS
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Client_ID
                            END AS OPP_Client_ID
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Client_Name
                            END AS OPP_Client_Name
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Subject_ID
                            END AS OPP_Subject_ID
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Subject_Name
                            END AS OPP_Subject_Name
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE CF_Job_Type2
                            END AS OPP_CF_Job_Type2
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_JOB_TYPE
                            END AS OPP_JOB_TYPE
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_STATUS
                            END AS OPP_STATUS
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE ENGAGEMENT_NUMBER
                            END AS OPP_ENGAGEMENT_NUMBER
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_STAGE
                            END AS OPP_STAGE
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Create_Date
                            END AS OPP_Create_Date
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN 0
                            ELSE OPP_NBC_Approved
                            END AS OPP_NBC_Approved
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_NBC_Date_Submitted
                            END AS OPP_NBC_Date_Submitted
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_NBC_Date_Approved
                            END AS OPP_NBC_Date_Approved
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Pitch_Date
                            END AS OPP_Pitch_Date
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE OPP_Currency
                            END AS OPP_Currency
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Max_Fee
                            END AS OPP_Max_Fee
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Min_Fee
                            END AS OPP_Min_Fee
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Total_Fee
                            END AS OPP_Total_Fee
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN NULL
                            ELSE OPP_Estimated_Close_Date
                            END AS OPP_Estimated_Close_Date
                        ,OPP_Staff_ID AS OPP_Staff_ID
                        ,OPP_Staff_Name AS OPP_Staff_Name
                        ,OPP_Staff_Role AS OPP_Staff_Role
                        ,Coverage_Officer_ID AS OPP_Coverage_Officer_ID
                        ,Coverage_Officer_Name AS OPP_Coverage_Officer_Name
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE Company_TIER
                            END AS OPP_Company_TIER
                        ,Flag AS OPP_Flag
                        ,CASE 
                            WHEN UPPER(DND_STATUS) = 'APPROVED'
                                THEN ''
                            ELSE LEGAL_ENTITY
                            END AS LEGAL_ENTITY
                        ,DND_STATUS AS DND_STATUS
                    FROM (
                    SELECT DISTINCT SFOpportunity.OPPORTUNITY_NUMBER_C AS Opportunity_NUMBER
                        ,SFOpportunity.FULL_OPPORTUNITY_ID_C AS OPP_ID
                        ,SFOpportunity.NAME AS NAME
                        ,SFOpportunity.LINE_OF_BUSINESS_C AS OPP_LINE_OF_BUSINESS
                        ,SFOpportunity.CLIENT_C AS OPP_Client_ID
                        ,CLIENT.NAME AS OPP_Client_Name 
                        ,SFOpportunity.SUBJECT_C AS OPP_Subject_ID
                        ,SFOpportunity.ORIGINAL_SUBJECT_NAME_C AS OPP_Subject_Name
                        ,SFOpportunity.JOB_TYPE_C AS CF_Job_Type2
                        ,CASE 
                            WHEN UPPER(SFOpportunity.JOB_TYPE_C) LIKE UPPER('%Advisory%')
                                THEN 'Advisory'
                            ELSE SFOpportunity.JOB_TYPE_C
                            END AS OPP_JOB_TYPE
                        ,SFOpportunity.STATUS_C AS OPP_STATUS
                        ,SFEngagement.ENGAGEMENT_NUMBER_C AS ENGAGEMENT_NUMBER
                        ,SFOpportunity.STAGE_C AS OPP_STAGE
                        ,SFOpportunity.CREATED_DATE AS OPP_Create_Date
                        ,SFOpportunityApproval.APPROVED_C AS OPP_NBC_Approved
                        ,SFOpportunityApproval.DATE_SUBMITTED_C AS OPP_NBC_Date_Submitted
                        ,SFOpportunityApproval.DATE_GRADED_C AS OPP_NBC_Date_Approved
                        ,SFOpportunity.PITCH_DATE_C AS OPP_Pitch_Date
                        ,SFOpportunity.CURRENCY_ISO_CODE AS OPP_Currency
                        ,(SFOpportunity.MAX_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Max_Fee
                        ,(SFOpportunity.MIN_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Min_Fee
                        ,(SFOpportunity.TOTAL_ESTIMATED_FEE_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Total_Fee
                        ,SFOpportunity.ESTIMATED_CLOSE_DATE_C AS OPP_Estimated_Close_Date
                        ,SFOpportunityInternalTeam.CONTACT_C AS OPP_Staff_ID
                        ,SFOpportunityInternalTeam.CONTACT_NAME_C AS OPP_Staff_Name
                        ,SFOpportunityInternalTeam.ROLE_C AS OPP_Staff_Role
                        ,Coverage_Table.Coverage_Officer_ID
                        ,Coverage_Table.Coverage_Officer_Name
                        ,Coverage_Table.Company_TIER
                        ,CASE 
                            WHEN Coverage_Table.Coverage_Officer_ID IN (
                                    SELECT CONTACT_C
                                    FROM OPPORTUNITY_INTERNAL_TEAM_C AS a
                                    WHERE SFOpportunity.OPPORTUNITY_NUMBER_C = a.OPPORTUNITY_NUMBER_C
                                        AND UPPER(a.ROLE_C) <> UPPER('Marketing Team')
                                    )
                                THEN 'Staffed On Deal'
                            ELSE 'Not Staffed On Deal'
                            END AS Flag
                        ,LEGAL_ENTITY.NAME AS LEGAL_ENTITY
                        ,SFOpportunity.DND_STATUS_C DND_STATUS
                    FROM {{ref('TGT_HL','VW_OPPORTUNITY_C')}} AS SFOpportunity 
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS CLIENT ON SFOpportunity.CLIENT_C = CLIENT.ID 
                    LEFT JOIN {{ref('TGT_HL','VW_OPPORTUNITY_APPROVAL_C')}} AS SFOpportunityApproval 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityApproval.OPPORTUNITY_NUMBER_C
                    LEFT JOIN {{ref('TGT_HL','VW_ENGAGEMENT_C')}} AS SFEngagement  
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFEngagement.OPPORTUNITY_NUMBER_C
                    INNER JOIN {{ref('TGT_HL','VW_OPPORTUNITY_INTERNAL_TEAM_C')}} AS SFOpportunityInternalTeam  
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityInternalTeam.OPPORTUNITY_NUMBER_C
                        AND UPPER(SFOpportunityInternalTeam.ROLE_C) NOT IN (UPPER('Marketing Team'))
                    INNER JOIN {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table ON (
                            SFOpportunity.CLIENT_C = Coverage_Table.Company_ID
                            OR SFOpportunity.SUBJECT_C = Coverage_Table.Company_ID
                            )
                    LEFT JOIN {{ref('TGT_HL','VW_LEGAL_ENTITY_C')}} LEGAL_ENTITY ON SFOPPORTUNITY.LEGAL_ENTITY_C = LEGAL_ENTITY.ID 
                    INNER JOIN {{ref('TGT_HL','VW_EXCHANGE_RATE_C')}} AS EXCHANGE_RATE  
                        ON SFOpportunity.CURRENCY_ISO_CODE = EXCHANGE_RATE.CURRENCY_ISO_CODE
                    WHERE UPPER(SFOpportunity.LINE_OF_BUSINESS_C) IN (
                            'CF'
                            ,'FR'
                            )
                        AND SFOpportunity.STAGE_C IS NOT NULL
                        AND DATEDIFF(YEAR, SFOpportunity.CREATED_DATE, GETDATE()) <= 5 
                        AND NOT (
                            UPPER(SFOpportunity.STATUS_C) IN (
                                UPPER('Dead')
                                ,UPPER('Closed')
                                )
                            AND SFOpportunity.CREATED_DATE < CAST(CONCAT (
                                    '04/01/'
                                    ,TO_VARCHAR(YEAR(GETDATE()))
                                    ) AS DATE)
                            )

                    UNION

                    SELECT DISTINCT SFOpportunity.OPPORTUNITY_NUMBER_C AS Opportunity_NUMBER
                        ,SFOpportunity.FULL_OPPORTUNITY_ID_C AS OPP_ID
                        ,SFOpportunity.NAME
                        ,SFOpportunity.LINE_OF_BUSINESS_C AS OPP_LINE_OF_BUSINESS
                        ,SFOpportunity.CLIENT_C AS OPP_Client_ID
                        ,CLIENT.NAME AS OPP_Client_Name 
                        ,SFOpportunity.SUBJECT_C AS OPP_Subject_ID
                        ,SFOpportunity.ORIGINAL_SUBJECT_NAME_C AS OPP_Subject_Name
                        ,SFOpportunity.JOB_TYPE_C AS CF_Job_Type2
                        ,CASE 
                            WHEN UPPER(SFOpportunity.JOB_TYPE_C) LIKE UPPER('%Advisory%')
                                THEN 'Advisory'
                            ELSE SFOpportunity.JOB_TYPE_C
                            END AS OPP_JOB_TYPE
                        ,SFOpportunity.STATUS_C AS OPP_STATUS
                        ,SFEngagement.ENGAGEMENT_NUMBER_C AS ENGAGEMENT_NUMBER
                        ,SFOpportunity.STAGE_C AS OPP_STAGE
                        ,SFOpportunity.CREATED_DATE AS OPP_Create_Date
                        ,SFOpportunityApproval.APPROVED_C AS OPP_NBC_Approved
                        ,SFOpportunityApproval.DATE_SUBMITTED_C AS OPP_NBC_Date_Submitted
                        ,SFOpportunityApproval.DATE_GRADED_C AS OPP_NBC_Date_Approved
                        ,SFOpportunity.PITCH_DATE_C AS OPP_Pitch_Date
                        ,SFOpportunity.CURRENCY_ISO_CODE AS OPP_Currency
                        ,(SFOpportunity.MAX_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Max_Fee
                        ,(SFOpportunity.MIN_FEE_M_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Min_Fee
                        ,(SFOpportunity.TOTAL_ESTIMATED_FEE_C * EXCHANGE_RATE.RATE_TO_USD_C) / 1000000 AS OPP_Total_Fee
                        ,SFOpportunity.ESTIMATED_CLOSE_DATE_C AS OPP_Estimated_Close_Date
                        ,SFOpportunityInternalTeam.CONTACT_C AS OPP_Staff_ID
                        ,SFOpportunityInternalTeam.CONTACT_NAME_C AS OPP_Staff_Name
                        ,SFOpportunityInternalTeam.ROLE_C AS OPP_Staff_Role
                        ,HLEmployee.HL_ID AS Coverage_Officer_ID
                        ,HLEmployee.FULL_NAME AS Coverage_Officer_Name
                        ,'Not Covered' AS Company_TIER
                        ,'Staffed On Deal' AS Flag
                        ,LEGAL_ENTITY.NAME AS LEGAL_ENTITY
                        ,SFOpportunity.DND_STATUS_C
                    FROM {{ref('TGT_HL','VW_OPPORTUNITY_C')}} AS SFOpportunity 
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS CLIENT ON SFOpportunity.CLIENT_C = CLIENT.ID
                    LEFT JOIN {{ref('TGT_HL','VW_OPPORTUNITY_APPROVAL_C')}} AS SFOpportunityApproval 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityApproval.OPPORTUNITY_NUMBER_C
                    LEFT JOIN {{ref('TGT_HL','VW_ENGAGEMENT_C')}} AS SFEngagement 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFEngagement.OPPORTUNITY_NUMBER_C
                    INNER JOIN {{ref('TGT_HL','VW_OPPORTUNITY_INTERNAL_TEAM_C')}} AS SFOpportunityInternalTeam 
                        ON SFOpportunity.OPPORTUNITY_NUMBER_C = SFOpportunityInternalTeam.OPPORTUNITY_NUMBER_C
                        AND SFOpportunityInternalTeam.ROLE_C NOT IN ('Marketing Team')
                    INNER JOIN {{ref('TGT_HL','TMP_HLEMPLOYEE')}} HLEmployee ON SFOpportunityInternalTeam.CONTACT_C = HLEmployee.HL_ID
                    INNER JOIN {{ref('TGT_HL','VW_ACCOUNT')}} AS SFAccount 
                        ON SFOpportunity.CLIENT_C = SFAccount.ID
                    INNER JOIN (SELECT '' ID, '' DEVELOPER_NAME)   AS SFRecordType  
                        ON SFAccount.RECORD_TYPE_ID = SFRecordType.ID
                    INNER JOIN (SELECT '' ID, '' DEVELOPER_NAME)  AS SFRecordTypeOpp 
                        ON SFOpportunity.RECORD_TYPE_ID = SFRecordTypeOpp.ID
                    LEFT JOIN {{ref('TGT_HL','VW_LEGAL_ENTITY_C')}} LEGAL_ENTITY ON SFOPPORTUNITY.LEGAL_ENTITY_C = LEGAL_ENTITY.ID
                    INNER JOIN {{ref('TGT_HL','VW_EXCHANGE_RATE_C')}} AS EXCHANGE_RATE  
                        ON SFOpportunity.CURRENCY_ISO_CODE = EXCHANGE_RATE.CURRENCY_ISO_CODE
                    WHERE UPPER(SFOpportunity.LINE_OF_BUSINESS_C) IN (
                            'CF'
                            ,'FR'
                            )
                        AND UPPER(SFRecordTypeOpp.DEVELOPER_NAME) IN (
                            'CF'
                            ,'FR'
                            ,'FAS'
                            )
                        AND SFOpportunity.STAGE_C IS NOT NULL
                        AND DATEDIFF(YEAR, SFOpportunity.CREATED_DATE, GETDATE()) <= 5 
                        AND NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = SFOpportunity.CLIENT_C
                            AND SFOpportunityInternalTeam.CONTACT_C = Coverage_Officer_ID
                            )
                        AND NOT EXISTS(
                            SELECT 1
                            FROM {{ref('TGT_HL','TMP_COVERAGE_ENGAGEMENT')}} Coverage_Table
                            WHERE Company_ID = SFOpportunity.SUBJECT_C
                            AND SFOpportunityInternalTeam.CONTACT_C = Coverage_Officer_ID
                            )
                        AND NOT (
                            UPPER(SFOpportunity.STATUS_C) IN (
                                UPPER('Dead')
                                ,UPPER('Closed')
                                )
                            AND SFOpportunity.CREATED_DATE < CAST(CONCAT (
                                    '04/01/'
                                    ,TO_VARCHAR(YEAR(GETDATE()))
                                    ) AS DATE)
                            )
                    ) OPP
            name: TMP_OPPORTUNITY
            noLinkRefs: []
      name: TMP_OPPORTUNITY
      overrideSQL: true
      schema: ""
      sqlType: Stage
      type: sql
    stepCounter: 87c08224-2455-4b17-b493-83876e56491e
